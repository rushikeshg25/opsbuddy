# OpsBuddy Notification Service

A Go-based notification service that consumes Kafka events from the ping service, analyzes logs using LLM, and sends email notifications via SMTP.

## Features

- **Kafka Consumer**: Listens to `notifications` topic for service down/up events
- **Log Analysis**: Fetches last 20 logs from TimescaleDB before failure timestamp
- **LLM Integration**: Uses OpenAI (or compatible) API to analyze logs and suggest fixes
- **Email Notifications**: Sends formatted email alerts via SMTP (Gmail supported)
- **Graceful Shutdown**: Proper cleanup of resources on termination

## Architecture

```
Kafka (notifications topic) â†’ Notification Service â†’ TimescaleDB (logs) â†’ LLM Analysis â†’ SMTP Email
```

## Setup

1. **Environment Variables**: Copy `.env.example` to `.env` and configure:

   ```bash
   cp .env.example .env
   ```

2. **Database**: Ensure TimescaleDB is running (via docker-compose.yml)

3. **Kafka**: Ensure Kafka is running with `notifications` topic created

4. **Dependencies**: Install Go dependencies:
   ```bash
   go mod tidy
   ```

5. **Gmail Setup** (for email notifications):
   - Enable 2-Factor Authentication on your Gmail account
   - Generate an App Password:
     1. Go to Google Account settings
     2. Security â†’ 2-Step Verification â†’ App passwords
     3. Generate password for "Mail"
     4. Use this app password (not your regular password) in `SMTP_FROM_PASSWORD`

## Configuration

### Required Environment Variables

- `DATABASE_URL`: Database connection string
- `KAFKA_BROKERS`: Kafka broker addresses (comma-separated)
- `KAFKA_TOPIC`: Kafka topic name for notifications

### Email Configuration (Optional - will mock if not set)

- `SMTP_FROM_EMAIL`: Gmail address for sending notifications
- `SMTP_FROM_PASSWORD`: Gmail app password (not regular password)
- `SMTP_HOST`: SMTP server (default: smtp.gmail.com)
- `SMTP_PORT`: SMTP port (default: 587)
- `SMTP_FROM_NAME`: Display name for emails (default: OpsBuddy Monitoring)

### LLM Configuration (Optional - will use mock analysis if not set)

- `OPENAI_API_KEY`: OpenAI API key for log analysis

### Optional Environment Variables

- `LLM_BASE_URL`: Custom LLM API endpoint
- `KAFKA_BROKERS`: Kafka broker addresses (default: localhost:9094)

## Usage

### Start the Service

```bash
go run main.go
```

### Docker Compose Integration

The service integrates with the existing docker-compose.yml setup:

```bash
# Start infrastructure
docker-compose up -d

# Initialize Kafka topics
./scripts/init-topics.sh

# Start notification service
go run main.go
```

## Message Flow

1. **Service Down Event**:

   - Ping service detects failure â†’ sends Kafka event
   - Notification service receives event
   - Fetches last 20 logs before failure timestamp
   - Analyzes logs with LLM for root cause and fixes
   - Sends formatted SMS with analysis and quick fixes

2. **Service Up Event**:
   - Ping service detects recovery â†’ sends Kafka event
   - Notification service receives event
   - Sends recovery SMS with downtime duration

## Email Notification Format

### Service Down Alert

**Subject:** ðŸš¨ ALERT: MyService is DOWN

**Body:**
```
Service Alert: MyService is currently DOWN

Issue Analysis: Database connection timeout detected

Recommended Quick Fixes:

1. [HIGH PRIORITY] Check Database Connection
   Verify database server is running and accessible

2. [MEDIUM PRIORITY] Restart Service
   Try restarting the service to clear connection pool

3. [LOW PRIORITY] Scale Resources
   Check if database needs more resources

---
This alert was generated by OpsBuddy Monitoring System
Please take immediate action to resolve the issue.
```

### Service Recovery

**Subject:** âœ… RESOLVED: MyService is back UP

**Body:**
```
Service Recovery: MyService is now operational

Total Downtime: 5m 30s

The service has been restored and is functioning normally.

---
This recovery notification was generated by OpsBuddy Monitoring System
```

## Development

### Project Structure

```
notification-service/
â”œâ”€â”€ main.go                 # Main application entry point
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ models.go          # Database models
â”‚   â”œâ”€â”€ database.go        # Database connection and queries
â”‚   â”œâ”€â”€ kafka.go           # Kafka consumer
â”‚   â”œâ”€â”€ llm.go             # LLM client for log analysis
â”‚   â”œâ”€â”€ email.go           # SMTP email client
â”‚   â””â”€â”€ processor.go       # Main notification processing logic
â”œâ”€â”€ .env.example           # Environment variables template
â””â”€â”€ README.md              # This file
```

### Testing

The service includes fallback mechanisms:

- **No LLM API**: Uses mock analysis with generic fixes
- **No SMTP**: Logs email messages instead of sending
- **No Logs**: Sends basic notification without analysis

### Monitoring

The service logs all operations:

- Kafka message consumption
- Database queries
- LLM API calls
- Email sending status
- Error handling

## Integration with Ping Service

The notification service expects Kafka events in this format:

```json
{
  "product_id": 123,
  "user_email": "user@example.com",
  "timestamp": "2024-01-01T12:00:00Z",
  "event_type": "service_down",
  "message": "Service MyService is down"
}
```

Events are produced by the ping service when:

- Service goes down (after retries fail)
- Service recovers (comes back up)

## Troubleshooting

### Common Issues

1. **Kafka Connection**: Ensure Kafka is running on localhost:9094
2. **Database Connection**: Verify database credentials and connectivity
3. **SMTP Email**: Check Gmail credentials and app password setup
4. **LLM API**: Verify OpenAI API key and rate limits

### Logs

Check service logs for detailed error messages and processing status.
